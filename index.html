<html ng-app="gpxmod">
  <head>
    <title>GPXmod</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
                           integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
                           crossorigin=""/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
                           integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
                           crossorigin="anonymous"/>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
            integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
            crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.3.1/gpx.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>

<style>
#mapid { height: 100%; }
</style>

<script>
var app = angular.module('gpxmod', []);

app.controller('TrackController', function($scope) {
  var color_palette = ['red', 'blue', 'green', 'yellow', 'magenta', 'cyan'];
  $scope.color_palette = color_palette;

  var trackPosMarker = L.circleMarker([51.505, -0.09], { radius: 7 });

  var map = L.map('mapid').setView([51.505, -0.09], 13);
  L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; 2013 OpenStreetMap contributors'
      }).addTo(map);

  function loadFromStorage(key, defaultValue) {
    var value = localStorage.getItem('gpxmod-tracks');
    return (value && JSON.parse(value)) || defaultValue;
  }

  $scope.tracks = loadFromStorage('gpxmod-tracks', []);

  function findClosestPoint(ps, p) {
    var closestIndex = -1;
    var closestPoint = null;
    var closestDistance = Infinity;
    for(var i = 0; i < ps.length; i++) {
      var distance = ps[i].distanceTo(p);
      if(distance < closestDistance) {
        closestIndex = i;
        closestPoint = ps[i];
        closestDistance = distance;
      }
    }

    return {
      index: closestIndex,
      latlng: closestPoint,
    };
  }

  $scope.$watchCollection('selection', function(newSelection, oldSelection) {
    if(newSelection) {
      trackPosMarker.setLatLng(newSelection.point.latlng).setStyle({color: newSelection.layer.options.color}).addTo(map);
      $scope.selectedPointIndex = newSelection.point.index;
    }
  });

  $scope.$watch('selectedPointIndex', function(newIndex, oldIndex) {
    if(newIndex && $scope.selection) {
      var newLatLng = $scope.selection.layer.getLatLngs()[newIndex];
      $scope.selection.point = {
        index: newIndex,
        latlng: newLatLng
      };
    }
  });

  $scope.addTrackToMap = function(track) {
    new L.GPX(track.gpx, {
      async: true,
      marker_options: {
        startIconUrl: null,
        endIconUrl: null
      },
      polyline_options: {
        color: color_palette[track.index % color_palette.length]
      }
    }).on('loaded', function(e) {
      console.log(e);
      map.fitBounds(e.target.getBounds());
    }).addTo(map)
    .on('click', function(e) {
      var point = findClosestPoint(e.layer.getLatLngs(), e.latlng);
      $scope.selection = {
        track: track,
        layer: e.layer,
        point: point
      };
      $scope.$digest();
    });
  };

  for(var i = 0; i < $scope.tracks.length; i++) {
    $scope.addTrackToMap($scope.tracks[i]);
  }

  $scope.newGpxTrackLoaded = function(filename, filecontent) {
    var newTrack = {
      name: filename,
      gpx: filecontent,
      index: $scope.tracks.length
    };

    $scope.addTrackToMap(newTrack);

    $scope.tracks.push(newTrack);
    localStorage.setItem('gpxmod-tracks', JSON.stringify($scope.tracks));

    $scope.$digest();
  };

  $scope.trimTrack = function(where) {
    var points = $scope.selection.layer.getLatLngs();
    if(where === 'before') {
      points = points.splice($scope.selection.point.index);
      $scope.selectedPointIndex = 0;
    } else if(where === 'after') {
      points.splice($scope.selection.point.index + 1);
    } else {
      console.log('where must be either before or after, was ' + where);
    }
    $scope.selection.layer.setLatLngs(points);
  };
});

app.directive("gpxTrackUpload",function(){    
  return {
    restrict: 'A',
    link: function($scope,el){          
      el.bind("change", function(evt){          
        if(!window.FileReader) return; // Browser is not compatible

        console.log('readering');
        var reader = new FileReader();

        var file = evt.target.files[0];

        reader.onload = function(evt) {
          if(evt.target.readyState != 2) return;
          if(evt.target.error) {
            alert('Error while reading file');
            return;
          }

          filecontent = evt.target.result;

          $scope.newGpxTrackLoaded(file.name, filecontent);
        }

        reader.readAsText(file);
      });          
    }        
  }
});
</script>
  </head>
  <body ng-controller="TrackController">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-3">
          <h1>GPXmod</h1>

          <form id="myform">
            <p>
            <input type="file" gpx-track-upload/>
            </p>
          </form>

          <ul class="list-unstyled">
            <li ng-repeat="track in tracks track by track.name">
              <span class="glyphicon glyphicon-minus" style="color: {{color_palette[track.index % color_palette.length]}};"></span>
              {{track.name}}
              <button type="button" class="btn btn-link btn-xs">
                <span class="glyphicon glyphicon-trash"></span>
              </button>
            </li>
          </ul>

          <h2>Editing</h2>
          <div ng-show="selection">
            <div>
              <span class="glyphicon glyphicon-minus" ng-style="{'color': color_palette[selection.track.index % color_palette.length]}"></span>
              <small>{{selection.track.name}}</small>
            </div>

            <form class="form form-inline">
              <div class="row">
                <div class="col-md-12">
                  <input class="form-control" type="number" ng-model="selectedPointIndex"/>
                  {{selection.point.latlng}}
                </div>
              </div>
            </form>
            <button class="btn btn-default" ng-click="trimTrack('before')">Trim Before</button>
            <button class="btn btn-default" ng-click="trimTrack('after')">Trim After</button>
          </div>
        </div>
        <div class="col-md-9">
          <div id="mapid"></div>
        </div>
      </div>
    </div>
  </body>
</html>
